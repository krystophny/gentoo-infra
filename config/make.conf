# /etc/portage/make.conf
# Gentoo optimized configuration with aggressive LTO/PGO
# https://github.com/krystophny/gentoo-infra

# -----------------------------------------------------------------------------
# CPU Optimization: Auto-detect at compile time
# -----------------------------------------------------------------------------
COMMON_FLAGS="-march=native -mtune=native -O3 -pipe"

# LTO: Parallel with automatic thread detection
COMMON_FLAGS="${COMMON_FLAGS} -flto=auto -fuse-linker-plugin"

# Graphite loop optimizations (requires GCC graphite USE flag)
COMMON_FLAGS="${COMMON_FLAGS} -fgraphite-identity -floop-nest-optimize"

# Additional aggressive optimizations
COMMON_FLAGS="${COMMON_FLAGS} -funroll-loops -ftree-vectorize"

# LTO error detection (catch ODR violations early)
COMMON_FLAGS="${COMMON_FLAGS} -Werror=odr -Werror=lto-type-mismatch"

CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"

# Linker flags for LTO
LDFLAGS="-Wl,-O2 -Wl,--as-needed -flto=auto"

# LTO-aware binutils wrappers
AR="gcc-ar"
NM="gcc-nm"
RANLIB="gcc-ranlib"

# -----------------------------------------------------------------------------
# Portage Build Settings
# -----------------------------------------------------------------------------
MAKEOPTS="-j$(nproc) -l$(nproc)"
EMERGE_DEFAULT_OPTS="--jobs=4 --load-average=$(nproc)"

# Features for aggressive optimization
FEATURES="candy fixlafiles unmerge-orphans parallel-fetch parallel-install"
FEATURES="${FEATURES} split-elog split-log"

# Accept testing packages selectively
ACCEPT_KEYWORDS="amd64"

# -----------------------------------------------------------------------------
# USE Flags: Desktop with NVIDIA, PipeWire, no systemd
# -----------------------------------------------------------------------------
USE="X xfce nvidia opengl vulkan pipewire elogind dbus"
USE="${USE} lto pgo graphite"
USE="${USE} fortran"
USE="${USE} -systemd -gnome -kde -wayland -pulseaudio"
USE="${USE} -bluetooth -cups -doc -test"

# -----------------------------------------------------------------------------
# Video Cards and Input Devices
# -----------------------------------------------------------------------------
VIDEO_CARDS="nvidia"
INPUT_DEVICES="libinput"

# -----------------------------------------------------------------------------
# 32-bit Support (required for Steam)
# -----------------------------------------------------------------------------
ABI_X86="64 32"

# -----------------------------------------------------------------------------
# Licenses
# -----------------------------------------------------------------------------
ACCEPT_LICENSE="*"

# -----------------------------------------------------------------------------
# Localization
# -----------------------------------------------------------------------------
LINGUAS="en"
L10N="en"

# -----------------------------------------------------------------------------
# Mirrors (adjust for your region)
# -----------------------------------------------------------------------------
GENTOO_MIRRORS="https://distfiles.gentoo.org"

# -----------------------------------------------------------------------------
# Portage Directories
# -----------------------------------------------------------------------------
PORTDIR="/var/db/repos/gentoo"
DISTDIR="/var/cache/distfiles"
PKGDIR="/var/cache/binpkgs"
